<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Tracking System Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .activity-item {
            border-left: 4px solid #007bff;
            background: #f8f9fa;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 0 8px 8px 0;
        }
        .activity-item.success { border-left-color: #28a745; }
        .activity-item.warning { border-left-color: #ffc107; }
        .activity-item.danger { border-left-color: #dc3545; }
        .activity-item.info { border-left-color: #17a2b8; }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-chart-line me-2"></i>
                    Activity Tracking System Test
                </h1>
                <p class="text-muted">Test all activity logging functionality and view recent user activities.</p>
            </div>
        </div>

        <!-- Test Activity Logging -->
        <div class="test-section">
            <h3><i class="fas fa-plus-circle me-2"></i>Test Activity Logging</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>Simulate User Activities</h5>
                    <div class="mb-3">
                        <label class="form-label">User ID:</label>
                        <input type="text" id="testUserId" class="form-control" value="test-user-123" placeholder="Enter user ID">
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="testAppointmentActivity()">
                            <i class="fas fa-calendar-plus me-1"></i>Log Appointment Created
                        </button>
                        <button class="btn btn-info" onclick="testPDFActivity()">
                            <i class="fas fa-file-pdf me-1"></i>Log PDF Generated
                        </button>
                        <button class="btn btn-primary" onclick="testLoginActivity()">
                            <i class="fas fa-sign-in-alt me-1"></i>Log User Login
                        </button>
                        <button class="btn btn-warning" onclick="testPaymentActivity()">
                            <i class="fas fa-credit-card me-1"></i>Log Payment Completed
                        </button>
                        <button class="btn btn-secondary" onclick="testDocumentActivity()">
                            <i class="fas fa-download me-1"></i>Log Document Download
                        </button>
                        <button class="btn btn-outline-primary" onclick="testProfileActivity()">
                            <i class="fas fa-user-edit me-1"></i>Log Profile Update
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>Activity Log Output</h5>
                    <div id="activityLog" class="log-output">
                        <em>Activity logs will appear here...</em>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary mt-2" onclick="clearLog()">
                        <i class="fas fa-trash me-1"></i>Clear Log
                    </button>
                </div>
            </div>
        </div>

        <!-- View User Activities -->
        <div class="test-section">
            <h3><i class="fas fa-list me-2"></i>View User Activities</h3>
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">User ID to Query:</label>
                        <input type="text" id="queryUserId" class="form-control" value="test-user-123">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Activity Type Filter:</label>
                        <select id="activityTypeFilter" class="form-select">
                            <option value="">All Activities</option>
                            <option value="appointment_created">Appointments</option>
                            <option value="pdf_generated">PDF Generation</option>
                            <option value="login">Logins</option>
                            <option value="payment_completed">Payments</option>
                            <option value="document_downloaded">Document Downloads</option>
                            <option value="profile_updated">Profile Updates</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Limit:</label>
                        <input type="number" id="activityLimit" class="form-control" value="10" min="1" max="50">
                    </div>
                    <button class="btn btn-primary w-100" onclick="loadUserActivities()">
                        <i class="fas fa-search me-1"></i>Load Activities
                    </button>
                </div>
                <div class="col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Recent Activities</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadUserActivities()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                    <div id="activitiesContainer">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <p>Click "Load Activities" to view user activity history</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Status -->
        <div class="test-section">
            <h3><i class="fas fa-database me-2"></i>Database Status</h3>
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-info w-100" onclick="checkDatabaseStatus()">
                        <i class="fas fa-check-circle me-1"></i>Check Database Connection
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-warning w-100" onclick="clearAllTestActivities()">
                        <i class="fas fa-trash-alt me-1"></i>Clear Test Activities
                    </button>
                </div>
            </div>
            <div id="databaseStatus" class="mt-3"></div>
        </div>
    </div>

    <script>
        let logCounter = 0;

        function logToOutput(message, type = 'info') {
            const log = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
            log.innerHTML += `<div class="text-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'}">[${timestamp}] ${icon} ${message}</div>`;
            log.scrollTop = log.scrollHeight;
            logCounter++;
        }

        function clearLog() {
            document.getElementById('activityLog').innerHTML = '<em>Activity logs cleared...</em>';
            logCounter = 0;
        }

        async function testAppointmentActivity() {
            const userId = document.getElementById('testUserId').value;
            if (!userId) {
                logToOutput('Please enter a User ID', 'error');
                return;
            }

            try {
                logToOutput(`Testing appointment activity for user: ${userId}`);
                
                const response = await fetch('/api/test-activity-logging', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        activityType: 'appointment',
                        testData: {
                            appointmentId: `test-appointment-${Date.now()}`,
                            serviceType: 'Eyebrow Microblading',
                            appointmentDate: new Date().toISOString(),
                            artistId: 'test-artist-1'
                        }
                    })
                });

                const result = await response.json();
                if (result.success) {
                    logToOutput('✅ Appointment activity logged successfully', 'success');
                } else {
                    logToOutput(`❌ Failed to log appointment activity: ${result.message}`, 'error');
                }
            } catch (error) {
                logToOutput(`❌ Error testing appointment activity: ${error.message}`, 'error');
            }
        }

        async function testPDFActivity() {
            const userId = document.getElementById('testUserId').value;
            if (!userId) {
                logToOutput('Please enter a User ID', 'error');
                return;
            }

            try {
                logToOutput(`Testing PDF activity for user: ${userId}`);
                
                const response = await fetch('/api/test-activity-logging', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        activityType: 'pdf',
                        testData: {
                            pdfType: 'health',
                            pdfId: `test-pdf-${Date.now()}`,
                            appointmentId: `test-appointment-${Date.now()}`
                        }
                    })
                });

                const result = await response.json();
                if (result.success) {
                    logToOutput('✅ PDF activity logged successfully', 'success');
                } else {
                    logToOutput(`❌ Failed to log PDF activity: ${result.message}`, 'error');
                }
            } catch (error) {
                logToOutput(`❌ Error testing PDF activity: ${error.message}`, 'error');
            }
        }

        async function testLoginActivity() {
            const userId = document.getElementById('testUserId').value;
            if (!userId) {
                logToOutput('Please enter a User ID', 'error');
                return;
            }

            try {
                logToOutput(`Testing login activity for user: ${userId}`);
                
                const response = await fetch('/api/test-activity-logging', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        activityType: 'login'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    logToOutput('✅ Login activity logged successfully', 'success');
                } else {
                    logToOutput(`❌ Failed to log login activity: ${result.message}`, 'error');
                }
            } catch (error) {
                logToOutput(`❌ Error testing login activity: ${error.message}`, 'error');
            }
        }

        async function testPaymentActivity() {
            const userId = document.getElementById('testUserId').value;
            if (!userId) {
                logToOutput('Please enter a User ID', 'error');
                return;
            }

            try {
                logToOutput(`Testing payment activity for user: ${userId}`);
                
                const response = await fetch('/api/test-activity-logging', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        activityType: 'payment',
                        testData: {
                            paymentMethod: 'card',
                            amount: 299.99,
                            appointmentId: `test-appointment-${Date.now()}`
                        }
                    })
                });

                const result = await response.json();
                if (result.success) {
                    logToOutput('✅ Payment activity logged successfully', 'success');
                } else {
                    logToOutput(`❌ Failed to log payment activity: ${result.message}`, 'error');
                }
            } catch (error) {
                logToOutput(`❌ Error testing payment activity: ${error.message}`, 'error');
            }
        }

        async function testDocumentActivity() {
            const userId = document.getElementById('testUserId').value;
            if (!userId) {
                logToOutput('Please enter a User ID', 'error');
                return;
            }

            try {
                logToOutput(`Testing document activity for user: ${userId}`);
                
                const response = await fetch('/api/test-activity-logging', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        activityType: 'document',
                        testData: {
                            action: 'download',
                            documentType: 'health',
                            documentId: `test-doc-${Date.now()}`,
                            appointmentId: `test-appointment-${Date.now()}`
                        }
                    })
                });

                const result = await response.json();
                if (result.success) {
                    logToOutput('✅ Document activity logged successfully', 'success');
                } else {
                    logToOutput(`❌ Failed to log document activity: ${result.message}`, 'error');
                }
            } catch (error) {
                logToOutput(`❌ Error testing document activity: ${error.message}`, 'error');
            }
        }

        async function testProfileActivity() {
            const userId = document.getElementById('testUserId').value;
            if (!userId) {
                logToOutput('Please enter a User ID', 'error');
                return;
            }

            try {
                logToOutput(`Testing profile activity for user: ${userId}`);
                
                const response = await fetch('/api/test-activity-logging', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        activityType: 'profile',
                        testData: {
                            updatedFields: ['firstName', 'phone', 'emergencyContactName']
                        }
                    })
                });

                const result = await response.json();
                if (result.success) {
                    logToOutput('✅ Profile activity logged successfully', 'success');
                } else {
                    logToOutput(`❌ Failed to log profile activity: ${result.message}`, 'error');
                }
            } catch (error) {
                logToOutput(`❌ Error testing profile activity: ${error.message}`, 'error');
            }
        }

        async function loadUserActivities() {
            const userId = document.getElementById('queryUserId').value;
            const activityType = document.getElementById('activityTypeFilter').value;
            const limit = document.getElementById('activityLimit').value;
            
            if (!userId) {
                alert('Please enter a User ID to query');
                return;
            }

            const container = document.getElementById('activitiesContainer');
            container.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>Loading activities...</p></div>';

            try {
                const params = new URLSearchParams({
                    userId,
                    limit: limit || '10'
                });
                
                if (activityType) {
                    params.append('activityType', activityType);
                }

                const response = await fetch(`/api/get-user-activities?${params}`);
                const result = await response.json();

                if (result.success) {
                    displayActivities(result.activities);
                    logToOutput(`✅ Loaded ${result.activities.length} activities for user ${userId}`, 'success');
                } else {
                    container.innerHTML = `<div class="alert alert-danger">Failed to load activities: ${result.message}</div>`;
                    logToOutput(`❌ Failed to load activities: ${result.message}`, 'error');
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">Error loading activities: ${error.message}</div>`;
                logToOutput(`❌ Error loading activities: ${error.message}`, 'error');
            }
        }

        function displayActivities(activities) {
            const container = document.getElementById('activitiesContainer');
            
            if (activities.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-inbox fa-2x mb-2"></i><p>No activities found</p></div>';
                return;
            }

            let html = '';
            activities.forEach(activity => {
                const timestamp = activity.timestamp?.toDate ? 
                    activity.timestamp.toDate().toLocaleString() : 
                    new Date(activity.timestamp).toLocaleString();

                html += `
                    <div class="activity-item ${activity.color}">
                        <div class="d-flex align-items-start">
                            <i class="${activity.icon} me-3 mt-1"></i>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${activity.title}</h6>
                                <p class="mb-1 text-muted small">${activity.description}</p>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>${timestamp}
                                    <span class="badge bg-${activity.color} ms-2">${activity.status}</span>
                                </small>
                                ${activity.metadata ? `
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <strong>Details:</strong> ${JSON.stringify(activity.metadata, null, 2)}
                                        </small>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function checkDatabaseStatus() {
            const statusDiv = document.getElementById('databaseStatus');
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Checking database connection...';

            try {
                const response = await fetch('/api/check-database-status');
                const result = await response.json();

                if (result.success) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Database connection successful
                            <br><small>Firebase configured: ${result.firebaseConfigured ? 'Yes' : 'No'}</small>
                            <br><small>Collections accessible: ${result.collectionsAccessible ? 'Yes' : 'No'}</small>
                        </div>
                    `;
                    logToOutput('✅ Database connection verified', 'success');
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Database connection failed: ${result.message}</div>`;
                    logToOutput(`❌ Database connection failed: ${result.message}`, 'error');
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error checking database: ${error.message}</div>`;
                logToOutput(`❌ Error checking database: ${error.message}`, 'error');
            }
        }

        async function clearAllTestActivities() {
            if (!confirm('Are you sure you want to clear all test activities? This action cannot be undone.')) {
                return;
            }

            try {
                logToOutput('Clearing all test activities...');
                
                const response = await fetch('/api/clear-test-activities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                if (result.success) {
                    logToOutput(`✅ Cleared ${result.deletedCount} test activities`, 'success');
                    loadUserActivities(); // Refresh the activities display
                } else {
                    logToOutput(`❌ Failed to clear test activities: ${result.message}`, 'error');
                }
            } catch (error) {
                logToOutput(`❌ Error clearing test activities: ${error.message}`, 'error');
            }
        }

        // Auto-load activities on page load
        window.addEventListener('load', () => {
            logToOutput('Activity tracking test page loaded', 'success');
        });
    </script>
</body>
</html>
